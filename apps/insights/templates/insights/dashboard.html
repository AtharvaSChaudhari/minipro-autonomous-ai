{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- Welcome banner (animated once per session) -->
<div id="welcomeBanner" class="hidden mb-4" data-show="{% if show_welcome %}1{% else %}0{% endif %}">
  <div class="rounded-xl border border-neutral-200 bg-white p-4 shadow-sm flex items-center gap-3 transition-all duration-500 ease-out opacity-0 translate-y-2">
    <div class="w-8 h-8 rounded-full bg-[var(--c-primary)]/10 flex items-center justify-center text-[var(--c-primary)]">ðŸ‘‹</div>
    <div>
      <div class="font-semibold text-[var(--c-n900)]">Welcome back{% if user.first_name %}, {{ user.first_name }}{% endif %}!</div>
      <div class="text-sm text-[var(--c-n500)]">Here are your latest spending and savings insights.</div>
    </div>
  </div>
  <script>
  (function(){
    try {
      const wrap = document.getElementById('welcomeBanner');
      const mustShow = wrap && wrap.getAttribute('data-show') === '1';
      const firstTime = !sessionStorage.getItem('welcomed');
      if (wrap && (mustShow || firstTime)) {
        wrap.classList.remove('hidden');
        const card = wrap.firstElementChild;
        requestAnimationFrame(()=>{
          card.classList.remove('opacity-0','translate-y-2');
          card.classList.add('opacity-100','translate-y-0');
        });
        setTimeout(()=>{ sessionStorage.setItem('welcomed','1'); }, 50);
        setTimeout(()=>{ if (wrap) wrap.classList.add('hidden'); }, 3500);
      }
    } catch(e){}
  })();
  </script>
</div>

<h2 class="text-2xl font-bold mb-6 text-[var(--c-n900)]">Financial Dashboard</h2>
{% if not insights %}
  <p class="text-[var(--c-n500)]">No insights available.</p>
{% else %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <div class="text-sm text-[var(--c-n500)]">Risk Score</div>
    <div class="text-4xl font-extrabold text-[var(--c-n900)]">{{ insights.risk_score|floatformat:0 }}/100</div>
    <div class="mt-2 text-sm text-[var(--c-n900)]">Loan Eligibility:
      <span class="px-2 py-1 rounded text-white {% if insights.loan_eligible %}bg-emerald-600{% else %}bg-rose-600{% endif %}">
        {% if insights.loan_eligible %}Eligible{% else %}Not Eligible{% endif %}
      </span>
    </div>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <div class="text-sm text-[var(--c-n500)]">Total Savings (computed)</div>
    <div class="text-4xl font-extrabold text-[var(--c-n900)]">â‚¹ {{ insights.total_savings|floatformat:0 }}</div>
    <div class="mt-2 text-sm text-[var(--c-n900)]">Monthly Income: â‚¹ {{ insights.income_per_month|floatformat:0 }}</div>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <div class="text-sm text-[var(--c-n500)]">Total Spend (180 days)</div>
    <div class="text-4xl font-extrabold text-[var(--c-n900)]">â‚¹ {{ insights.total_spend_180|floatformat:0 }}</div>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <h3 class="font-semibold mb-2 text-[var(--c-n900)]">Monthly Spend</h3>
    <canvas id="spendChart" height="120"></canvas>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <h3 class="font-semibold mb-2 text-[var(--c-n900)]">Monthly Savings</h3>
    <canvas id="savingsChart" height="120"></canvas>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm md:col-span-2">
    <h3 class="font-semibold mb-2 text-[var(--c-n900)]">Income vs Expense Trend</h3>
    <canvas id="incomeExpenseChart" height="120"></canvas>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <h3 class="font-semibold mb-2 text-[var(--c-n900)]">Top Categories</h3>
    <canvas id="catChart" height="120"></canvas>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <h3 class="font-semibold mb-2 text-[var(--c-n900)]">UPI App Distribution</h3>
    <canvas id="upiChart" height="120"></canvas>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <h3 class="font-semibold mb-2 text-[var(--c-n900)]">Expense-to-Income Ratio</h3>
    <canvas id="ratioChart" height="120"></canvas>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm">
    <h3 class="font-semibold mb-2 text-[var(--c-n900)]">Spending Volatility</h3>
    <div class="text-sm text-[var(--c-n500)]">Std Dev: <span id="volStd">0</span> â€¢ Index: <span id="volIdx">0%</span></div>
    <div class="mt-3 h-2 rounded bg-neutral-100 overflow-hidden">
      <div id="volBar" class="h-2 bg-[var(--c-primary)] rounded" style="width:0%"></div>
    </div>
  </div>
  <div class="bg-white rounded-xl p-6 border border-neutral-200 shadow-sm md:col-span-2">
    <h3 class="font-semibold mb-2 text-[var(--c-n900)]">Spending Spikes</h3>
    <div class="text-sm text-[var(--c-n500)] mb-2">Months above threshold (avg + 1Ã—std): <span id="spikeList"></span></div>
    <canvas id="spikesChart" height="120"></canvas>
  </div>
</div>

<script>
const insights = JSON.parse('{{ insights_json|default:"{}"|escapejs }}');
const months = Object.keys(insights.monthly_spendings || {});
const spend = months.map(m => insights.monthly_spendings[m] || 0);
const save = months.map(m => (insights.monthly_savings && insights.monthly_savings[m]) || 0);
const income = months.map(m => (insights.income_series && insights.income_series[m]) || (insights.income_per_month || 0));
const ratio = months.map(m => (insights.expense_to_income_ratio && insights.expense_to_income_ratio[m]) || 0);

const axisColor = '#393D45';
new Chart(document.getElementById('spendChart'), {
  type: 'line',
  data: {labels: months, datasets: [{label: 'Spend', data: spend, borderColor: '#042E6F', backgroundColor: 'rgba(4,46,111,0.12)', fill: true, tension: .3}]},
  options: {plugins:{legend:{labels:{color:axisColor}}}, scales:{x:{ticks:{color:axisColor}},y:{ticks:{color:axisColor}}}}
});
new Chart(document.getElementById('savingsChart'), {
  type: 'bar',
  data: {labels: months, datasets: [{label: 'Savings', data: save, backgroundColor: '#63C577'}]},
  options: {plugins:{legend:{labels:{color:axisColor}}}, scales:{x:{ticks:{color:axisColor}},y:{ticks:{color:axisColor}}}}
});

// Income vs Expense Trend
new Chart(document.getElementById('incomeExpenseChart'), {
  data: {
    labels: months,
    datasets: [
      {type:'line', label:'Income', data: income, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.15)', fill:true, tension:.25},
      {type:'bar', label:'Expense', data: spend, backgroundColor:'#ef4444'}
    ]
  },
  options: {plugins:{legend:{labels:{color:axisColor}}}, scales:{x:{ticks:{color:axisColor}}, y:{ticks:{color:axisColor}}}}
});

const catLabels = Object.keys(insights.categories || {});
const catVals = catLabels.map(k => insights.categories[k] || 0);
new Chart(document.getElementById('catChart'), {
  type: 'doughnut',
  data: {labels: catLabels, datasets:[{data: catVals, backgroundColor:['#f59e0b','#ef4444','#10b981','#60a5fa','#a78bfa','#f472b6','#f87171','#34d399','#93c5fd','#fde68a','#c4b5fd','#fdba74']}]},
  options: {plugins:{legend:{labels:{color:axisColor}}}}
});

const upiLabels = Object.keys(insights.upi_distribution || {});
const upiVals = upiLabels.map(k => insights.upi_distribution[k] || 0);
new Chart(document.getElementById('upiChart'), {
  type: 'polarArea',
  data: {labels: upiLabels, datasets:[{data: upiVals, backgroundColor:['#60a5fa','#34d399','#f59e0b','#ef4444','#a78bfa','#f472b6','#f87171','#fde68a']}]},
  options: {plugins:{legend:{labels:{color:axisColor}}}}
});

// Expense-to-Income Ratio
new Chart(document.getElementById('ratioChart'), {
  type: 'line',
  data: {labels: months, datasets:[{label:'Expense/Income %', data: ratio, borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.15)', fill:true, tension:.3}]},
  options: {plugins:{legend:{labels:{color:axisColor}}}, scales:{x:{ticks:{color:axisColor}}, y:{ticks:{color:axisColor, callback:(v)=> v+'%'}}}}
});

// Volatility card
try {
  const volStd = Number(insights.spending_volatility_std || 0).toFixed(0);
  const volIdx = Math.round(Number(insights.spending_volatility_index || 0));
  const volStdEl = document.getElementById('volStd');
  const volIdxEl = document.getElementById('volIdx');
  const volBar = document.getElementById('volBar');
  if (volStdEl) volStdEl.textContent = 'â‚¹ '+volStd;
  if (volIdxEl) volIdxEl.textContent = volIdx+'%';
  if (volBar) volBar.style.width = Math.max(0, Math.min(100, volIdx)) + '%';
} catch(e) {}

// Spending Spikes (bar + threshold line)
(function(){
  const avg = spend.reduce((a,b)=>a+b,0) / (spend.length || 1);
  const std = Number(insights.spending_volatility_std || 0);
  const threshold = avg + std;
  const thArr = months.map(()=> threshold);
  const spikes = insights.spending_spikes || [];
  const list = document.getElementById('spikeList');
  if (list) {
    if (spikes.length) {
      list.innerHTML = spikes.map(m=>`<span class="inline-block px-2 py-0.5 mr-1 mb-1 rounded bg-rose-50 text-rose-700 border border-rose-200 text-xs">${m}</span>`).join('');
    } else {
      list.textContent = 'None';
    }
  }
  new Chart(document.getElementById('spikesChart'), {
    data: {labels: months, datasets:[
      {type:'bar', label:'Spend', data: spend, backgroundColor:'#f59e0b'},
      {type:'line', label:'Threshold', data: thArr, borderColor:'#6b7280', borderDash:[6,4], pointRadius:0}
    ]},
    options: {plugins:{legend:{labels:{color:axisColor}}}, scales:{x:{ticks:{color:axisColor}}, y:{ticks:{color:axisColor}}}}
  });
})();
</script>
{% endif %}
{% endblock %}
